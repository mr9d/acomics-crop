(()=>{"use strict";var e,t,n,o,i,r,a,c,s,l,d,u,h,p=function(e,t){return n=void 0,o=[e,t],r=function(e,t){var n,o,i=t.quality,r=void 0===i?1:i,a=t.type,c=void 0===a?e.type:a;return function(e,t){var n,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(i=2&c[0]?o.return:c[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,c[1])).done)return i;switch(o=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((i=(i=a.trys).length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],o=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}(this,(function(t){switch(t.label){case 0:return[4,createImageBitmap(e)];case 1:return n=t.sent(),(o=document.createElement("canvas")).width=n.width,o.height=n.height,o.getContext("2d").drawImage(n,0,0),[4,new Promise((function(e){return o.toBlob(e,c,r)}))];case 2:return[2,t.sent()]}}))},new((i=void 0)||(i=Promise))((function(e,t){function a(e){try{s(r.next(e))}catch(e){t(e)}}function c(e){try{s(r.throw(e))}catch(e){t(e)}}function s(t){var n;t.done?e(t.value):(n=t.value,n instanceof i?n:new i((function(e){e(n)}))).then(a,c)}s((r=r.apply(n,o||[])).next())}));var n,o,i,r},_=function(){var e=document.body.style.top;document.body.style.position="",document.body.style.top="",window.scrollTo(0,-1*parseInt(e||"0")),document.body.style.overflowY=""},m=new DataTransfer,v=new FileReader,b=((e=document.createElement("div")).className="resize-module resize-module_disable",e.insertAdjacentHTML("beforeend",'<div class="resize-module-background"></div> <div class="resize-module-container"> <div class="resize-module-container__header"> <div class="resize-module-container__header-text">Ваша фотография</div> <div class="resize-module-container__close-button"></div> </div> <p class="resize-module-container__body-paragraph">Выберите часть изображения, которая будет использоваться</p> <div class="resize-module-container__body"> <div class="resize-module-container__body-box"> <div class="resize-module-container__body-image"> <div class="resize-module-container__background-box"> <div class="resize-module-container__background resize-module-container__background_pos_t"></div> <div class="resize-module-container__background resize-module-container__background_pos_l"></div> <div class="resize-module-container__background resize-module-container__background_pos_b"></div> <div class="resize-module-container__background resize-module-container__background_pos_r"></div> </div> <div class="resize-module-container__body-image-area"> <div class="scale-cube scale-cube_pos_tl"></div> <div class="scale-cube scale-cube_pos_tr"></div> <div class="scale-cube scale-cube_pos_bl"></div> <div class="scale-cube scale-cube_pos_br"></div> </div> </div> </div> </div> <div class="resize-module-container__footer"> <div class="resize-module-container__button resize-module-container__button_type-confirm"> <span>Сохранить изменения</span> </div> <div class="resize-module-container__button resize-module-container__button_type-deny"> <span>Вернуться назад</span> </div> </div> <canvas class="canvas_crop"></canvas> </div> '),document.body.appendChild(e),e),f=1,y=document.querySelectorAll('input[class="imageResizeAndCrop"]'),g=b.querySelector(".resize-module-container__body-image"),w=b.querySelector(".resize-module-container__body-image-area"),z=b.querySelector(".resize-module-container__button_type-confirm"),x=b.querySelector(".resize-module-container__button_type-deny"),k=b.querySelector(".resize-module-container__close-button"),S=g.getBoundingClientRect(),E=0,q=0,L=0,C=0,H=0,M=0,I=function(e){u=l,h=d,"touchstart"===e.type||"touchmove"===e.type||"touchend"===e.type?(l=e.touches[0].clientX,d=e.touches[0].clientY):(l=e.clientX,d=e.clientY)},B=function(){E<0&&(L+=E,E=0),q<0&&(C+=q,q=0),L<0&&(E+=L,L=0),C<0&&(q+=C,C=0)},R=function(e){e.preventDefault(),S=g.getBoundingClientRect(),I(e),1===H?(c=q+S.left,s=S.height+S.top-L):2===H?(c=S.width+S.left-C,s=S.height+S.top-L):3===H?(c=S.width+S.left-C,s=E+S.top):4===H?(c=q+S.left,s=E+S.top):(c=l,s=d,E<=d-S.top&&L<=S.top+S.height-d&&q<=l-S.left&&C<=S.left+S.width-l&&(H=-1)),b.addEventListener("touchmove",T),b.addEventListener("mousemove",T)};g.addEventListener("mousedown",R),g.addEventListener("touchstart",R),b.querySelector(".scale-cube_pos_tr").addEventListener("mousedown",(function(){H=1})),b.querySelector(".scale-cube_pos_tl").addEventListener("mousedown",(function(){H=2})),b.querySelector(".scale-cube_pos_bl").addEventListener("mousedown",(function(){H=3})),b.querySelector(".scale-cube_pos_br").addEventListener("mousedown",(function(){H=4})),b.querySelector(".scale-cube_pos_tr").addEventListener("touchstart",(function(){H=1})),b.querySelector(".scale-cube_pos_tl").addEventListener("touchstart",(function(){H=2})),b.querySelector(".scale-cube_pos_bl").addEventListener("touchstart",(function(){H=3})),b.querySelector(".scale-cube_pos_br").addEventListener("touchstart",(function(){H=4}));var T=function(e){I(e);var o=0,i=0;M=0,-1!==H&&(1===H?(q=c,L=S.height-s):2===H?(C=S.width-c,L=S.height-s):3===H?(C=S.width-c,E=s):4===H&&(q=c,E=s),l>=c?(o=1,q=c-S.left,C=S.width+S.left-l):(o=-1,q=l-S.left,C=S.width+S.left-c),d>=s?(i=1,E=s-S.top,L=S.height+S.top-d):(i=-1,E=d-S.top,L=S.height+S.top-s),1===o&&-1===i?M=1:-1===o&&-1===i?M=2:-1===o&&1===i?M=3:1===o&&1===i&&(M=4)),1!==M&&2!==M||(E=d-S.top)<0&&(E=0),3!==M&&4!==M||(L=S.top+S.height-d)<0&&(L=0),2!==M&&3!==M||(q=l-S.left)<0&&(q=0),4!==M&&1!==M||(C=S.left+S.width-l)<0&&(C=0),0!==t&&0!==n&&D(),B(),G(),X()},D=function(){var e=(S.width-q-C)*n,o=(S.height-E-L)*t;1===M?e<=o?E+=(o-e)/t:C+=(e-o)/n:2===M?e<=o?E+=(o-e)/t:q+=(e-o)/n:3===M?e<=o?L+=(o-e)/t:q+=(e-o)/n:4===M?e<=o?L+=(o-e)/t:C+=(e-o)/n:-1===H&&(q+=l-u,C-=l-u,E+=d-h,L-=d-h,u=l,h=d)},Y=function(){var e,o;D(),e=S.height-E-L,o=S.width-q-C,(e<n/f||o<t/f)&&(1===M?(E=S.height-L-n/f,C=S.width-q-t/f):2===M?(E=S.height-L-n/f,q=S.width-C-t/f):3===M?(L=S.height-E-n/f,q=S.width-C-t/f):4===M&&(L=S.height-E-n/f,C=S.width-q-t/f)),D(),B(),G(),X(),H=0,b.removeEventListener("mousemove",T),b.removeEventListener("touchmove",T)};b.addEventListener("mouseup",Y),b.addEventListener("touchend",Y);var A=function(e){return i=void 0,r=void 0,s=function(){var i,r,c,s;return function(e,t){var n,o,i,r,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return r={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function c(c){return function(s){return function(c){if(n)throw new TypeError("Generator is already executing.");for(;r&&(r=0,c[0]&&(a=0)),a;)try{if(n=1,o&&(i=2&c[0]?o.return:c[0]?o.throw||((i=o.return)&&i.call(o),0):o.next)&&!(i=i.call(o,c[1])).done)return i;switch(o=0,i&&(c=[2&c[0],i.value]),c[0]){case 0:case 1:i=c;break;case 4:return a.label++,{value:c[1],done:!1};case 5:a.label++,o=c[1],c=[0];continue;case 7:c=a.ops.pop(),a.trys.pop();continue;default:if(!((i=(i=a.trys).length>0&&i[i.length-1])||6!==c[0]&&2!==c[0])){a=0;continue}if(3===c[0]&&(!i||c[1]>i[0]&&c[1]<i[3])){a.label=c[1];break}if(6===c[0]&&a.label<i[1]){a.label=i[1],i=c;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(c);break}i[2]&&a.ops.pop(),a.trys.pop();continue}c=t.call(e,a)}catch(e){c=[6,e],o=0}finally{n=i=0}if(5&c[0])throw c[1];return{value:c[0]?c[1]:void 0,done:!0}}([c,s])}}}(this,(function(l){switch(l.label){case 0:return a=e.target,t=Number(a.dataset.targetWidth),n=Number(a.dataset.targetHeight),i=b.querySelector(".resize-module-container__header-text"),r=b.querySelector(".resize-module-container__body-paragraph"),a.dataset.moduleHeader&&(i.textContent=a.dataset.moduleHeader),a.dataset.moduleDescription&&(r.textContent=a.dataset.moduleDescription),c=a.files[0],[4,p(c,{quality:Math.min(1,2097152/c.size),type:"image/jpeg"})];case 1:return s=l.sent(),v.readAsDataURL(s),v.addEventListener("load",(function(){(o=new Image).src=v.result,o.addEventListener("load",F)}),{once:!0}),[2]}}))},new((c=void 0)||(c=Promise))((function(e,t){function n(e){try{a(s.next(e))}catch(e){t(e)}}function o(e){try{a(s.throw(e))}catch(e){t(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof c?i:new c((function(e){e(i)}))).then(n,o)}a((s=s.apply(i,r||[])).next())}));var i,r,c,s},F=function(){o.width<t||o.height<n?(W(),alert("Размер изображения не соответствует заданным параметрам.")):o.width!==t||o.height!==n?(document.body.style.top="-"+window.scrollY+"px",document.body.style.position="fixed",document.body.clientHeight>document.scrollingElement.clientHeight&&(document.body.style.overflowY="scroll"),e.classList.remove("resize-module_disable"),P()):N()},P=function(){i=o.naturalWidth,r=o.naturalHeight;var e=i/Math.min(window.innerWidth,900),a=r/Math.min(window.innerHeight-200,600);f=Math.min(e,a),g.style.width=i/f-88+"px",g.style.height=r/f-88+"px",g.style.backgroundSize=i/f-88+"px "+(r/f-88)+"px",g.style.backgroundImage="url('"+v.result+"')",S=g.getBoundingClientRect(),g.scrollIntoView({block:"center",inline:"center"});var c=Math.min(S.width,S.height*t/n),s=Math.min(S.height,S.width*n/t);q=(S.width-c)/2,C=(S.width-c)/2,E=(S.height-s)/2,L=(S.height-s)/2,G(),X()},N=function(){if(a.dataset.submitOnSuccess){var e=a.closest("form");e&&HTMLFormElement.prototype.submit.call(e)}},W=function(){a.files=null,a.value="",j()},j=function(){_(),e.classList.add("resize-module_disable")},G=function(){w.style.height=S.height-E-L+"px",w.style.width=S.width-q-C+"px",b.querySelector(".resize-module-container__background_pos_t").style.height=E+"px",b.querySelector(".resize-module-container__background_pos_b").style.height=L+"px",b.querySelector(".resize-module-container__background_pos_l").style.top=E+"px",b.querySelector(".resize-module-container__background_pos_l").style.bottom=L+"px",b.querySelector(".resize-module-container__background_pos_l").style.width=q+"px",b.querySelector(".resize-module-container__background_pos_r").style.top=E+"px",b.querySelector(".resize-module-container__background_pos_r").style.bottom=L+"px",b.querySelector(".resize-module-container__background_pos_r").style.width=C+"px"},X=function(){w.style.backgroundPosition=-q+"px "+-E+"px",w.style.left=q+"px",w.style.right=C+"px",w.style.top=E+"px",w.style.bottom=L+"px"};y.forEach((function(e){e.addEventListener("change",A)})),k.addEventListener("click",W),x.addEventListener("click",W),z.addEventListener("click",(function(){_();var e=i/S.width,c=r/S.height,s=b.querySelector(".canvas_crop");s.width=t,s.height=n,s.getContext("2d").drawImage(o,q*e,E*c,i-q*e-C*e,r-E*c-L*c,0,0,s.width,s.height),s.toBlob((function(e){m.items.clear(),m.items.add(new File([e],"updatedFile.png",{type:"image/png"})),a.files=m.files,N()})),j()}))})();